<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.market.dao.OrderMapper">
	
	<!-- 1. 페이징 -->
	<select id = "getTotalRecordsCount" parameterType="String" resultType = "int">
 		select
 			count(*)
 		from
 			order_table ot
 		where		   
				user_num = (select distinct user_num
							from user_table
							where user_mail= 'abc@gmail.com')
 			<if test = "searchWord != ''">
 				ot.item_num in (select item_Num
		 					from item_table
		 					where item_name like '%'||#{searchWord }||'%')
 			</if>
 	</select>

	<!-- 1. 주문목록 불러오기 -->
	<select id="getOrderList" resultType="Order" parameterType="HashMap">
		select 
		    ot.order_num as orderNum,
			(select item_name
        		from item_table
				where item_num = ot.item_num) as itemName,
		    ot.order_address as orderAddress,
		    ot.order_mail as orderMail,
		    ot.order_call as orderCall,
		    ot.amount as amount,
		    to_char(ot.indate, 'yy/mm/dd hh24:mi:ss') as indate,
            (select price
                from item_table 
                where item_num = ot.item_num) as price
		from   
		    order_table ot,
		    (select
		    	rownum as rn,
		    	order_num as ln
		    from
		    	order_table
			where		   
				user_num = (select distinct user_num
							from user_table
							where user_mail= 'abc@gmail.com')
		    order by
		    	order_num) rt
		where
		<if test = "searchWord != ''">
			ot.item_num in (select item_num
			        			from item_table
								where item_name like '%'||#{searchWord }||'%')
			and
		</if>
			ot.order_num = rt.ln
		and
			rt.rn between #{startRecord } + 1 and #{startRecord } + #{countPerPage }
		order by order_num
	</select>
	
	<!-- 2. 주문 취소 -->
	<delete id="orderCancel" parameterType="List">
		delete from order_table
		where order_num = 
		<foreach collection='list' index="index" item='item' separator="or order_num =" open=" " close=" ">
		#{item }
		</foreach>
	</delete>
	
	<!-- 장바구니에 상품넣기 -->
	<insert id="insertCart" parameterType="HashMap">
		insert into cart_table(
			cart_num,
			item_num,
			cart_amount
		) values (
			cart_num_seq.nextval,
			#{itemNum },
			#{cartAmount }
		)
	</insert>
	
	<!-- 장바구니에 같은 상품이 있는지 확인 -->
	<select id="checkCart" parameterType="int" resultType="Cart">
		select
			cart_num as cartNum,
			item_num as itemNum
		from
			cart_table
		where
			item_num = #{itemNum }
	</select>
	
	<!-- 장바구니에 같은 상품이 있다면 수량을 증가 -->
	<update id="updateCartAmount" parameterType="HashMap">
		update 
			cart_table
		set
			cart_amount = cart_amount + #{cartAmount }
		where
			item_num = #{itemNum }
	</update>
	
	<!-- 장바구니 조회 -->
	<select id="selectCartList" resultType="Item">
		select
		    c.cart_num as cartNum,
		    i.item_num as itemNum,
		    i.item_name as itemName,
		    i.price as price,
		    c.cart_amount as cartAmount
		from
		    cart_table c, item_table i
		where
		    c.item_num = i.item_num
	</select>
</mapper>